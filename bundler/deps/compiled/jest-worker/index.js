(()=>{"use strict";var e={662:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:true});r.default=void 0;var o=_interopRequireDefault(t(475));var i=t(893);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,r,t){if(r in e){Object.defineProperty(e,r,{value:t,enumerable:true,configurable:true,writable:true})}else{e[r]=t}return e}class Farm{constructor(e,r,t={}){var i,u;this._numOfWorkers=e;this._callback=r;_defineProperty(this,"_computeWorkerKey",void 0);_defineProperty(this,"_workerSchedulingPolicy",void 0);_defineProperty(this,"_cacheKeys",Object.create(null));_defineProperty(this,"_locks",[]);_defineProperty(this,"_offset",0);_defineProperty(this,"_taskQueue",void 0);this._computeWorkerKey=t.computeWorkerKey;this._workerSchedulingPolicy=(i=t.workerSchedulingPolicy)!==null&&i!==void 0?i:"round-robin";this._taskQueue=(u=t.taskQueue)!==null&&u!==void 0?u:new o.default}doWork(e,...r){const t=new Set;const addCustomMessageListener=e=>{t.add(e);return()=>{t.delete(e)}};const onCustomMessage=e=>{t.forEach((r=>r(e)))};const o=new Promise(((r,o,u)=>{const n=this._computeWorkerKey;const s=[i.CHILD_MESSAGE_CALL,false,e,r];let l=null;let a=null;if(n){a=n.call(this,e,...r);l=a==null?null:this._cacheKeys[a]}const onStart=e=>{if(a!=null){this._cacheKeys[a]=e}};const onEnd=(e,r)=>{t.clear();if(e){u(e)}else{o(r)}};const _={onCustomMessage:onCustomMessage,onEnd:onEnd,onStart:onStart,request:s};if(l){this._taskQueue.enqueue(_,l.getWorkerId());this._process(l.getWorkerId())}else{this._push(_)}}).bind(null,r));o.UNSTABLE_onCustomMessage=addCustomMessageListener;return o}_process(e){if(this._isLocked(e)){return this}const r=this._taskQueue.dequeue(e);if(!r){return this}if(r.request[1]){throw new Error("Queue implementation returned processed task")}const t=r.onEnd;const onEnd=(r,o)=>{t(r,o);this._unlock(e);this._process(e)};r.request[1]=true;this._lock(e);this._callback(e,r.request,r.onStart,onEnd,r.onCustomMessage);return this}_push(e){this._taskQueue.enqueue(e);const r=this._getNextWorkerOffset();for(let t=0;t<this._numOfWorkers;t++){this._process((r+t)%this._numOfWorkers);if(e.request[1]){break}}return this}_getNextWorkerOffset(){switch(this._workerSchedulingPolicy){case"in-order":return 0;case"round-robin":return this._offset++}}_lock(e){this._locks[e]=true}_unlock(e){this._locks[e]=false}_isLocked(e){return this._locks[e]}}r.default=Farm},475:(e,r)=>{Object.defineProperty(r,"__esModule",{value:true});r.default=void 0;function _defineProperty(e,r,t){if(r in e){Object.defineProperty(e,r,{value:t,enumerable:true,configurable:true,writable:true})}else{e[r]=t}return e}class FifoQueue{constructor(){_defineProperty(this,"_workerQueues",[]);_defineProperty(this,"_sharedQueue",new InternalQueue)}enqueue(e,r){if(r==null){this._sharedQueue.enqueue(e);return}let t=this._workerQueues[r];if(t==null){t=this._workerQueues[r]=new InternalQueue}const o=this._sharedQueue.peekLast();const i={previousSharedTask:o,task:e};t.enqueue(i)}dequeue(e){var r,t,o;const i=(r=this._workerQueues[e])===null||r===void 0?void 0:r.peek();const u=(t=i===null||i===void 0?void 0:(o=i.previousSharedTask)===null||o===void 0?void 0:o.request[1])!==null&&t!==void 0?t:true;if(i!=null&&u){var n,s,l;return(n=(s=this._workerQueues[e])===null||s===void 0?void 0:(l=s.dequeue())===null||l===void 0?void 0:l.task)!==null&&n!==void 0?n:null}return this._sharedQueue.dequeue()}}r.default=FifoQueue;class InternalQueue{constructor(){_defineProperty(this,"_head",null);_defineProperty(this,"_last",null)}enqueue(e){const r={next:null,value:e};if(this._last==null){this._head=r}else{this._last.next=r}this._last=r}dequeue(){if(this._head==null){return null}const e=this._head;this._head=e.next;if(this._head==null){this._last=null}return e.value}peek(){var e,r;return(e=(r=this._head)===null||r===void 0?void 0:r.value)!==null&&e!==void 0?e:null}peekLast(){var e,r;return(e=(r=this._last)===null||r===void 0?void 0:r.value)!==null&&e!==void 0?e:null}}},882:(e,r)=>{Object.defineProperty(r,"__esModule",{value:true});r.default=void 0;function _defineProperty(e,r,t){if(r in e){Object.defineProperty(e,r,{value:t,enumerable:true,configurable:true,writable:true})}else{e[r]=t}return e}class PriorityQueue{constructor(e){this._computePriority=e;_defineProperty(this,"_queue",[]);_defineProperty(this,"_sharedQueue",new MinHeap)}enqueue(e,r){if(r==null){this._enqueue(e,this._sharedQueue)}else{const t=this._getWorkerQueue(r);this._enqueue(e,t)}}_enqueue(e,r){const t={priority:this._computePriority(e.request[2],...e.request[3]),task:e};r.add(t)}dequeue(e){const r=this._getWorkerQueue(e);const t=r.peek();const o=this._sharedQueue.peek();if(o==null||t!=null&&t.priority<=o.priority){var i,u;return(i=(u=r.poll())===null||u===void 0?void 0:u.task)!==null&&i!==void 0?i:null}return this._sharedQueue.poll().task}_getWorkerQueue(e){let r=this._queue[e];if(r==null){r=this._queue[e]=new MinHeap}return r}}r.default=PriorityQueue;class MinHeap{constructor(){_defineProperty(this,"_heap",[])}peek(){var e;return(e=this._heap[0])!==null&&e!==void 0?e:null}add(e){const r=this._heap;r.push(e);if(r.length===1){return}let t=r.length-1;while(t>0){const o=Math.floor((t+1)/2)-1;const i=r[o];if(i.priority<=e.priority){break}r[t]=i;r[o]=e;t=o}}poll(){const e=this._heap;const r=e[0];const t=e.pop();if(r==null||e.length===0){return r!==null&&r!==void 0?r:null}let o=0;e[0]=t!==null&&t!==void 0?t:null;const i=e[0];while(true){let r=null;const t=(o+1)*2;const u=t-1;const n=e[t];const s=e[u];if(s!=null&&s.priority<i.priority){r=u}if(n!=null&&n.priority<(r==null?i:s).priority){r=t}if(r==null){break}e[o]=e[r];e[r]=i;o=r}return r}}},562:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:true});r.default=void 0;var o=_interopRequireDefault(t(711));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const canUseWorkerThreads=()=>{try{t(13);return true}catch{return false}};class WorkerPool extends o.default{send(e,r,t,o,i){this.getWorkerById(e).send(r,t,o,i)}createWorker(e){let r;if(this._options.enableWorkerThreads&&canUseWorkerThreads()){r=require("@effect-x/deps/compiled/jest-worker/workers/NodeThreadsWorker").default}else{r=require("@effect-x/deps/compiled/jest-worker/workers/ChildProcessWorker").default}return new r(e)}}var i=WorkerPool;r.default=i},711:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:true});r.default=void 0;function path(){const e=_interopRequireWildcard(t(622));path=function(){return e};return e}function _mergeStream(){const e=_interopRequireDefault(t(367));_mergeStream=function(){return e};return e}function _types(){const e=require("@effect-x/deps/compiled/jest-worker/types");_types=function(){return e};return e}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if(typeof WeakMap!=="function")return null;var r=new WeakMap;var t=new WeakMap;return(_getRequireWildcardCache=function(e){return e?t:r})(e)}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule){return e}if(e===null||typeof e!=="object"&&typeof e!=="function"){return{default:e}}var t=_getRequireWildcardCache(r);if(t&&t.has(e)){return t.get(e)}var o={};var i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e){if(u!=="default"&&Object.prototype.hasOwnProperty.call(e,u)){var n=i?Object.getOwnPropertyDescriptor(e,u):null;if(n&&(n.get||n.set)){Object.defineProperty(o,u,n)}else{o[u]=e[u]}}}o.default=e;if(t){t.set(e,o)}return o}function _defineProperty(e,r,t){if(r in e){Object.defineProperty(e,r,{value:t,enumerable:true,configurable:true,writable:true})}else{e[r]=t}return e}const o=500;const emptyMethod=()=>{};class BaseWorkerPool{constructor(e,r){_defineProperty(this,"_stderr",void 0);_defineProperty(this,"_stdout",void 0);_defineProperty(this,"_options",void 0);_defineProperty(this,"_workers",void 0);this._options=r;this._workers=new Array(r.numWorkers);if(!path().isAbsolute(e)){e=require.resolve(e)}const t=(0,_mergeStream().default)();const o=(0,_mergeStream().default)();const{forkOptions:i,maxRetries:u,resourceLimits:n,setupArgs:s}=r;for(let l=0;l<r.numWorkers;l++){const r={forkOptions:i,maxRetries:u,resourceLimits:n,setupArgs:s,workerId:l,workerPath:e};const a=this.createWorker(r);const _=a.getStdout();const d=a.getStderr();if(_){t.add(_)}if(d){o.add(d)}this._workers[l]=a}this._stdout=t;this._stderr=o}getStderr(){return this._stderr}getStdout(){return this._stdout}getWorkers(){return this._workers}getWorkerById(e){return this._workers[e]}createWorker(e){throw Error("Missing method createWorker in WorkerPool")}async end(){const e=this._workers.map((async e=>{e.send([_types().CHILD_MESSAGE_END,false],emptyMethod,emptyMethod,emptyMethod);let r=false;const t=setTimeout((()=>{e.forceExit();r=true}),o);await e.waitForExit();clearTimeout(t);return r}));const r=await Promise.all(e);return r.reduce(((e,r)=>({forceExited:e.forceExited||r})),{forceExited:false})}}r.default=BaseWorkerPool},893:(e,r)=>{Object.defineProperty(r,"__esModule",{value:true});r.PARENT_MESSAGE_CUSTOM=r.PARENT_MESSAGE_SETUP_ERROR=r.PARENT_MESSAGE_CLIENT_ERROR=r.PARENT_MESSAGE_OK=r.CHILD_MESSAGE_END=r.CHILD_MESSAGE_CALL=r.CHILD_MESSAGE_INITIALIZE=void 0;const t=0;r.CHILD_MESSAGE_INITIALIZE=t;const o=1;r.CHILD_MESSAGE_CALL=o;const i=2;r.CHILD_MESSAGE_END=i;const u=0;r.PARENT_MESSAGE_OK=u;const n=1;r.PARENT_MESSAGE_CLIENT_ERROR=n;const s=2;r.PARENT_MESSAGE_SETUP_ERROR=s;const l=3;r.PARENT_MESSAGE_CUSTOM=l},367:e=>{e.exports=require("@effect-x/deps/compiled/merge-stream")},87:e=>{e.exports=require("os")},622:e=>{e.exports=require("path")},13:e=>{e.exports=require("worker_threads")}};var r={};function __nccwpck_require__(t){var o=r[t];if(o!==undefined){return o.exports}var i=r[t]={exports:{}};var u=true;try{e[t](i,i.exports,__nccwpck_require__);u=false}finally{if(u)delete r[t]}return i.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var t={};(()=>{var e=t;Object.defineProperty(e,"__esModule",{value:true});Object.defineProperty(e,"PriorityQueue",{enumerable:true,get:function(){return i.default}});Object.defineProperty(e,"FifoQueue",{enumerable:true,get:function(){return u.default}});Object.defineProperty(e,"messageParent",{enumerable:true,get:function(){return n.default}});e.Worker=void 0;function _os(){const e=__nccwpck_require__(87);_os=function(){return e};return e}var r=_interopRequireDefault(__nccwpck_require__(662));var o=_interopRequireDefault(__nccwpck_require__(562));var i=_interopRequireDefault(__nccwpck_require__(882));var u=_interopRequireDefault(__nccwpck_require__(475));var n=_interopRequireDefault(require("@effect-x/deps/compiled/jest-worker/workers/messageParent"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,r,t){if(r in e){Object.defineProperty(e,r,{value:t,enumerable:true,configurable:true,writable:true})}else{e[r]=t}return e}function getExposedMethods(e,r){let t=r.exposedMethods;if(!t){const r=require(e);t=Object.keys(r).filter((e=>typeof r[e]==="function"));if(typeof r==="function"){t=[...t,"default"]}}return t}class Worker{constructor(e,t){var i,u,n,s,l,a;_defineProperty(this,"_ending",void 0);_defineProperty(this,"_farm",void 0);_defineProperty(this,"_options",void 0);_defineProperty(this,"_workerPool",void 0);this._options={...t};this._ending=false;const _={enableWorkerThreads:(i=this._options.enableWorkerThreads)!==null&&i!==void 0?i:false,forkOptions:(u=this._options.forkOptions)!==null&&u!==void 0?u:{},maxRetries:(n=this._options.maxRetries)!==null&&n!==void 0?n:3,numWorkers:(s=this._options.numWorkers)!==null&&s!==void 0?s:Math.max((0,_os().cpus)().length-1,1),resourceLimits:(l=this._options.resourceLimits)!==null&&l!==void 0?l:{},setupArgs:(a=this._options.setupArgs)!==null&&a!==void 0?a:[]};if(this._options.WorkerPool){this._workerPool=new this._options.WorkerPool(e,_)}else{this._workerPool=new o.default(e,_)}this._farm=new r.default(_.numWorkers,this._workerPool.send.bind(this._workerPool),{computeWorkerKey:this._options.computeWorkerKey,taskQueue:this._options.taskQueue,workerSchedulingPolicy:this._options.workerSchedulingPolicy});this._bindExposedWorkerMethods(e,this._options)}_bindExposedWorkerMethods(e,r){getExposedMethods(e,r).forEach((e=>{if(e.startsWith("_")){return}if(this.constructor.prototype.hasOwnProperty(e)){throw new TypeError("Cannot define a method called "+e)}this[e]=this._callFunctionWithArgs.bind(this,e)}))}_callFunctionWithArgs(e,...r){if(this._ending){throw new Error("Farm is ended, no more calls can be done to it")}return this._farm.doWork(e,...r)}getStderr(){return this._workerPool.getStderr()}getStdout(){return this._workerPool.getStdout()}async end(){if(this._ending){throw new Error("Farm is ended, no more calls can be done to it")}this._ending=true;return this._workerPool.end()}}e.Worker=Worker})();module.exports=t})();